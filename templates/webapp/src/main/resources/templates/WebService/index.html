{#include base}
  {#title}<title>Java Quarkus WebApp</title>{/title}
{#pagehead}
<script src="/js/angular.min.js"></script>
<script>
var app = angular.module("FruitManagement", []);

//Controller Part
app.controller("FruitManagementController", function ($scope, $http) {

//Initialize page with default data which is blank in this example
$scope.fruits = [];

$scope.form = {
  id: -1,
  name: ""
};

//Now load the data from server
_refreshPageData();

//HTTP POST/PUT methods for add/edit fruits
$scope.update = function () {
  var method = "";
  var url = "";
  var data = {};
  if ($scope.form.id == -1) {
    //Id is absent so add fruits - POST operation
    method = "POST";
    url = '/fruits';
    data.name = $scope.form.name;
    data.category = $scope.form.category;
    data.notes = $scope.form.notes;
  } else {
    //If Id is present, it's edit operation - PUT operation
    method = "PUT";
    url = '/fruits/' + $scope.form.id;
    data.name = $scope.form.name;
    data.category = $scope.form.category;
    data.notes = $scope.form.notes;
  }

  $http({
    method: method,
    url: url,
    data: angular.toJson(data),
    headers: {
      'Content-Type': 'application/json'
    }
  }).then(_success, _error);
};

//HTTP DELETE- delete fruit by id
$scope.remove = function (fruit) {
  $http({
    method: 'DELETE',
      url: '/fruits/' + fruit.id
    }).then(_success, _error);
  };

  //In case of edit fruits, populate form with fruit data
  $scope.edit = function (fruit) {
    $scope.form.name = fruit.name;
    $scope.form.category = fruit.category;
    $scope.form.notes = fruit.notes;
    $scope.form.id = fruit.id;
  };

  /* Private Methods */
  //HTTP GET- get all fruits collection
  function _refreshPageData() {
    $http({
      method: 'GET',
      url: '/fruits'
    }).then(function successCallback(response) {
      $scope.fruits = response.data;
    }, function errorCallback(response) {
      console.log(response.statusText);
    });
  }

  function _success(response) {
    _refreshPageData();
    _clearForm()
  }

  function _error(response) {
    alert(response.data.message || response.statusText);
  }

  //Clear the form
  function _clearForm() {
    $scope.form.name = "";
    $scope.form.category = "";
    $scope.form.notes = "";
    $scope.form.id = -1;
  }
});
</script>
{/pagehead}
{#content}
<div ng-app="FruitManagement" ng-controller="FruitManagementController">

<div class="container">

<div class="card">
  <h1>CRUD Mission - Quarkus</h1>
  <p>This application demonstrates how a Quarkus application implements a CRUD endpoint to manage fruits.
This management interface invokes the CRUD service endpoint, which interacts with a database using JPA and several other well known libraries.
  </p>
  <div>Behind the scenes, we have:
    <ul>
      <li>Hibernate ORM taking care of all CRUD operations</li>
      <li>RESTEasy powering the REST API</li>
      <li>ArC, a CDI based dependency injection framework</li>
      <li>the Narayana Transaction Manager coordinating all transactions</li>
      <li>Agroal, the high performance Datasource implementation</li>
      <li>Infinispan used as Hibernate 2nd level caching: enabled on both entities and queries</li>
      <li>The Undertow webserver</li>
      <li>Some magic bytecode generation plugged in the compiler...</li>
    </ul>
  </div>
</div>

<div class="card m-3 p-3">
  <h3>Add/Edit a fruit</h3>
  <form ng-submit="update()">
    <div class="m-3">
      <label for="name" class="form-label">Name</label>
      <input type="text" id="name" name="name" placeholder="Name" class="form-control" ng-model="form.name" />
    </div>
    <div class="m-3">
      <label for="category" class="form-label">Category</label>
      <input type="text" id="category" name="category" placeholder="Category" class="form-control" ng-model="form.category" />
    </div>
    <div class="m-3">
      <label for="notes" class="form-label">Notes</label>
      <input type="text" id="notes" name="notes" placeholder="Notes" class="form-control" ng-model="form.notes" />
    </div>
    <div class="m-3">
      <input type="submit" value="Save" /><input type="reset" />
    </div>
  </form>
</div>
<div class="container">
  <table class="table">
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Category</th>
      <th>Notes</th>
      <th></th>
    </tr>
    
    <tr ng-repeat="fruit in fruits">
      <td>{{ fruit.id }}</td>
      <td>{{ fruit.name }}</td>
      <td>{{ fruit.category }}</td>
      <td>{{ fruit.notes }}</td>
      <td>
        <a ng-click="edit( fruit )" class="btn">Edit</a>
        <a ng-click="remove( fruit )" class="btn">Remove</a>
      </td>
    </tr>
  </table>
</div>

</div>

</div>
{/content}

{/include}
